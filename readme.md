# MyGame - 2D射击生存游戏

基于SDL3开发的2D射击生存游戏，采用模块化设计，支持复杂的物品系统、状态管理和网络架构。

## 项目概述

这是一个C++开发的2D射击生存游戏，具有以下特点：
- 基于SDL3图形库的实时渲染
- 复杂的物品和装备系统
- 状态驱动的行为管理
- 无限生成的地图系统
- 完整的音效管理
- 准网络多人游戏架构

### 核心设计理念

#### 武器系统
- **手持武器机制**: 所有武器只有在手持时才发挥武器作用
- **无装备槽设计**: 没有传统的武器装备槽概念，玩家需要主动选择和切换武器
- **真实生存体验**: 手部装备位置专为手套等防护装备设计，增加游戏的真实感和策略性

## 编译和运行

### 系统要求

- CMake 3.16 或更高版本
- C++17 兼容的编译器
  - Windows: Visual Studio 2019 或更高版本
  - Linux: GCC 9+ 或 Clang 10+
  - macOS: Xcode 11+ 或 Clang 10+

### 依赖库

项目已包含所有必要的依赖库：
- **SDL3**: 图形、音频、输入处理
- **SDL3_ttf**: 字体渲染
- **nlohmann/json**: JSON解析

### 编译说明

#### Windows (Visual Studio)

**支持的Visual Studio版本及对应生成器**：
- Visual Studio 2019: `"Visual Studio 16 2019"`
- Visual Studio 2022: `"Visual Studio 17 2022"`

**完整编译步骤**：

1. 确保已安装对应版本的Visual Studio
2. 克隆仓库：
   ```bash
   git clone <repository-url>
   cd broken
   ```
3. 创建编译目录：
   ```bash
   mkdir build
   cd build
   ```
4. 生成项目文件（根据你的VS版本选择）：
   ```bash
   # Visual Studio 2022 (推荐)
   cmake .. -G "Visual Studio 17 2022" -A x64
   
   # Visual Studio 2019
   cmake .. -G "Visual Studio 16 2019" -A x64
   ```
5. 编译项目：
   ```bash
   # Debug版本 (带调试信息，exe大小约3.5MB)
   cmake --build . --config Debug
   
   # Release版本 (优化版本，exe大小约600KB)
   cmake --build . --config Release
   ```
6. 运行游戏：
   ```bash
   # Debug版本
   cd bin\Debug
   .\broken.exe
   
   # Release版本
   cd bin\Release
   .\broken.exe
   ```

**Visual Studio IDE方式**：
1. 打开Visual Studio
2. 选择"打开本地文件夹"
3. 选择项目根目录
4. 等待CMake配置完成
5. 在顶部工具栏选择配置（Debug/Release）
6. 按F5运行或Ctrl+Shift+B编译

#### Linux

1. 安装依赖：
   ```bash
   # Ubuntu/Debian
   sudo apt-get install build-essential cmake
   
   # CentOS/RHEL
   sudo yum install gcc-c++ cmake
   ```
2. 克隆并编译：
```bash
git clone <repository-url>
cd broken
mkdir build
cd build
cmake ..
make -j$(nproc)
   ```

#### macOS

1. 安装 Xcode Command Line Tools：
   ```bash
   xcode-select --install
   ```
2. 安装 CMake（通过 Homebrew）：
   ```bash
   brew install cmake
   ```
3. 克隆并编译：
   ```bash
   git clone <repository-url>
   cd broken
   mkdir build
   cd build
   cmake ..
   make -j$(sysctl -n hw.ncpu)
```

### 编译选项和配置

#### CMake配置选项

```bash
# 不同Visual Studio版本的生成器
cmake .. -G "Visual Studio 17 2022" -A x64  # VS 2022 (推荐)
cmake .. -G "Visual Studio 16 2019" -A x64  # VS 2019

# Linux/macOS构建类型
cmake .. -DCMAKE_BUILD_TYPE=Debug    # Debug模式
cmake .. -DCMAKE_BUILD_TYPE=Release  # Release模式
```

#### 构建配置区别

| 配置 | 大小 | 优化 | 调试信息 | 控制台 | 性能 |
|------|------|------|----------|--------|------|
| Debug | ~3.5MB | 无 | 完整 | 显示 | 较低 |
| Release | ~600KB | 最大 | 无 | 显示 | 最佳 |

**推荐配置**：
- **开发调试**: 使用Debug配置，方便调试和查看控制台输出
- **正式发布**: 使用Release配置，体积小、性能好

### 故障排除

#### 编译问题
1. **CMake生成器错误**: 确保使用正确的Visual Studio版本对应的生成器
   ```bash
   # 错误: cmake ..
   # 正确: cmake .. -G "Visual Studio 17 2022" -A x64
   ```

2. **编码错误（Windows）**: 项目已配置UTF-8编码支持，确保使用Visual Studio 2019+

3. **SDL3库找不到**: 确保SDL3库文件在 `libs/` 目录中

4. **CMakeSettings.json错误**: 如果Visual Studio提示CMakeSettings错误，删除该文件重新配置

#### 运行问题
1. **找不到.exe文件**: 程序生成在 `build/bin/Debug/` 或 `build/bin/Release/` 目录中
   ```bash
   # 正确路径
   cd build/bin/Debug
   .\broken.exe
   ```

2. **缺少DLL文件**: SDL3相关DLL会自动复制，如果丢失请重新编译

3. **资源文件找不到**: 确保assets、jsons、map文件夹已正确复制到exe同目录

#### 权限问题
- 确保对项目目录有读写权限
- Windows可能需要以管理员身份运行PowerShell/命令提示符

## 核心架构

### 程序入口与主循环

#### main.cpp
程序入口点，负责：
- 设置控制台编码为UTF-8 
- 初始化Game单例
- 启动游戏主循环

#### Game类 (Game.h/cpp)
游戏的核心管理类，采用单例模式，负责：
- **SDL系统初始化**：窗口、渲染器、字体、音频
- **游戏循环管理**：事件处理、更新、渲染、清理
- **实体容器管理**：玩家、怪物、生物、子弹
- **系统协调**：地图、UI、音效、网络
- **相机和视口控制**：缩放、跟随玩家
- **游戏时间控制**：时间倍率调整(0.1x-10x)

主要方法：
- `init()`: 初始化所有系统
- `run()`: 主游戏循环
- `handleEvents()`: 处理输入事件
- `update()`: 更新游戏状态
- `render()`: 渲染所有元素

## 实体系统架构

### Entity基类 (Entity.h)
所有游戏实体的基类，提供：

**核心属性**：
- 位置坐标 (x, y)
- 移动速度和半径
- 生命值和阵营
- 碰撞检测器

**状态管理**：
- 双重状态系统（旧EntityState + 新EntityStateManager）
- 实体标志系统（EntityFlag）
- 状态计时器和修正系数

**装备系统**：
- 集成装备管理器（EquipmentSystem）
- 多槽位装备支持
- 存储空间管理

**行为系统**：
- 行为队列（ActionQueue）
- 延时动作执行
- 状态依赖的行为控制

**战斗能力**：
- 射击接口和冷却管理
- 自动换弹和武器维护
- 伤害计算和接收

### Player类 (Player.h)
玩家实体，继承Entity，额外提供：

**输入处理**：
- 键盘和鼠标事件响应
- 世界坐标和屏幕坐标转换
- 射击和交互控制

**物品管理**：
- 手持物品系统（武器只有在手持时发挥作用，无装备槽概念）
- 与存储空间的交互
- 装备穿戴管理（手部位置专为手套等防护装备设计）

**网络支持**：
- 玩家ID和名称
- 本地/远程玩家区分
- 控制器关联

**技能系统**：
- 25种技能分类（火器、近战、生活技能）
- 0-20级等级系统，每级100经验点
- 自动经验获得机制（攻击命中、使用武器）
- 主技能+副技能双重经验（如步枪+枪法）

**身体部位伤害系统**：
- 六个独立身体部位：头部(50血)、躯干(120血)、双腿(90血)、双臂(75血)
- 权重随机命中：按血量比例随机选择受伤部位
- 致命伤害机制：头部或躯干血量归零即死亡
- 部分伤害影响：四肢受伤不致死但影响行动能力

**闪避系统**：
- 基于敏捷属性的闪避能力：每3秒可闪避(闪避等级/5+2)次
- 闪避等级18 = 5次/3秒的闪避机会
- d3判定系统：攻击者敏捷次数×d3 vs 防御者敏捷+d3+闪避等级
- 闪避成功获得技能经验，失败则受到伤害

**近战攻击系统**：
- 完整的命中检定：(最高伤害技能等级 + 0.4×近战等级) + 敏捷d3 + 武器命中加成 vs 敏捷d3 + 近战命中难度
- 武器命中加成：匕首+3、剑类+2、长矛+1、锤子+0
- 命中难度属性：生物可设置近战/远程命中难度增加防御能力
- 闪避判定：命中后目标还可尝试闪避避免伤害

### Creature类 (Creature.h) - 新生物系统
正在替换Monster的新生物系统：

**生物属性**：
- 生物类型（人形、动物、不死等）
- 年龄、体型、感官能力
- 能量、体力、智能等级

**AI行为**：
- 状态机驱动的行为
- 目标选择和追踪
- 攻击模式管理

**感知系统**：
- 视觉、听觉、嗅觉范围
- 环境感知和威胁评估
- 群体行为本能

### Monster类 (Monster.h) - 旧系统（待替换）
当前的敌人系统，包含：
- 简单的状态机（空闲、追逐、攻击、死亡）
- 武器装备和背包系统
- 碰撞检测和射线检测

### Zombie类 (Zombie.h)
继承Creature的具体实现：
- 丧尸类型区分（普通、奔跑者、坦克等）
- 感知驱动的行为模式
- 气味和声音追踪系统

## 物品系统架构

### Item基类 (Item.h)
所有物品的基础类：

**基本属性**：
- 名称、重量、体积、长度、价值
- 稀有度等级
- 描述和唯一标识符

**分类系统**：
- 基于ItemFlag的标签系统
- 替代传统枚举分类
- 支持多重标签

**装备属性**：
- 可装备槽位定义
- 攻击和防御属性
- 耐久度系统

**存储能力**：
- 内置存储空间列表
- 容器物品支持

### Gun类 (Gun.h)
武器系统的核心：

**枪械属性**：
- 枪械类型（手枪、步枪、机枪等）
- 射击模式（半自动、全自动、栓动等）
- 性能参数（射速、精度、后坐力、人体工程学）

**弹药系统**：
- 兼容弹药类型列表
- 弹匣装填机制
- 膛内子弹管理

**配件系统**：
- 多槽位配件支持（瞄具、枪管、握把等）
- 配件对性能的影响计算
- 槽位容量管理

**射击机制**：
- 射击冷却和声音
- 自动上膛系统
- 弹道参数影响

### Storage类 (Storage.h)
存储系统：

**容量限制**：
- 重量、体积、长度限制
- 物品数量限制
- 动态容量调整

**访问控制**：
- 存取时间成本
- 折叠显示状态
- 内容可见性

**物品管理**：
- 添加/移除物品
- 按类型/名称查找
- 容量检查

### Magazine类, Ammo类, GunMod类
专门的物品子类，提供特定功能

## 地图系统架构

### Map类 (Map.h)
无限地图管理：

**网格系统**：
- 基于哈希表的网格存储
- 动态加载/卸载机制
- 异步加载支持

**地图生成**：
- 程序化地图生成
- 地图数据序列化
- 障碍物管理

**性能优化**：
- 视距裁剪
- 分帧加载
- 内存管理

### Grid类, Tile类
地图的基本构成单元

## 状态管理系统

### EntityStateManager类 (EntityStateManager.h)
新的状态管理系统：

**状态效果**：
- 多状态并存
- 优先级系统
- 持续时间管理

**状态回调**：
- 状态变化事件
- 网络同步支持
- 序列化功能

### PlayerStateManager类
玩家专用状态管理器

## 行为系统

### ActionQueue类 (ActionQueue.h)
行为队列管理：

**队列控制**：
- 行为排队执行
- 暂停/恢复机制
- 中断处理

**时间管理**：
- 行为持续时间
- 累计时间追踪
- 状态同步

### Action类及子类 (Action.h)
各种具体行为的实现：
- 武器操作（换弹、上膛）
- 物品管理（存储、取出、装备）
- 状态变化行为

## UI系统

### GameUI类 (GameUI.h)
主要游戏界面：

**窗口管理**：
- 玩家背包界面
- 物品提示框
- 模态窗口控制

**交互系统**：
- 鼠标悬停检测
- 拖拽操作
- 点击事件处理

**存储界面**：
- 存储空间可视化
- 物品转移界面
- 坐标映射系统

### HUD类 (HUD.h)
游戏内覆盖界面：
- 生命值显示
- 弹药信息
- 坐标和倍率显示
- 行为进度条

### UIWindow类, UIElement类
UI组件的基础框架

## 战斗系统

### Bullet类 (Bullet.h)
子弹物理和碰撞：

**弹道系统**：
- 线性运动模拟
- 射程限制
- 穿透机制

**碰撞检测**：
- 线段-圆形碰撞
- 线段-矩形碰撞
- 实体碰撞判定

### Damage类 (Damage.h)
伤害计算系统：

**伤害类型**：
- 多种伤害类型支持
- 穿透值计算
- 伤害来源追踪

**伤害处理**：
- 伤害合并和缩放
- 防御计算
- 暴击系统

### DamageNumber类 (DamageNumber.h)
伤害数字飘字系统：

**飘字类型**：
- 普通伤害：金黄色数字显示
- 暴击伤害：红色大号数字，附带感叹号
- 未命中：蓝色"MISS"文字显示

**动画效果**：
- 短暂向上飘动后停止
- 渐变透明度消失效果
- 暴击文字放大1.5倍显示
- 不同类型持续时间不同（miss 1.5秒，普通 2秒，暴击 3秒）

**显示机制**：
- 自动在受伤位置上方生成
- 所有攻击未命中都显示miss（玩家攻击怪物、怪物攻击玩家）
- 使用像素字体确保清晰显示

## 音效系统

### SoundManager类 (SoundManager.h)
音效管理：
- 单例模式
- 音效文件加载
- 播放控制
- SDL音频集成

## 网络架构

### PlayerController类 (PlayerController.h)
玩家控制抽象：
- 本地/远程控制器
- 输入状态同步
- 网络命令处理

### RemotePlayerController类
远程玩家控制器实现

## 数据管理

### ItemLoader类 (ItemLoader.h)
物品数据加载：

**模板系统**：
- JSON配置文件解析
- 物品模板缓存
- 实例创建工厂

**数据分类**：
- 武器、弹药、配件模板
- 多类型物品支持
- 热加载能力

### 配置文件 (jsons/items.json)
包含所有物品的定义：
- 武器属性和配件槽位
- 弹药伤害和弹道参数
- 物品标志和装备信息

## 运行流程

### 初始化阶段
1. SDL系统初始化（视频、音频、字体）
2. 创建全屏窗口和渲染器
3. 加载音效文件和字体资源
4. 初始化地图系统
5. 创建玩家实体
6. 加载物品配置数据
7. 设置初始游戏状态

### 游戏循环
1. **事件处理**：处理键盘、鼠标、窗口事件
2. **状态更新**：
   - 更新玩家状态和输入
   - 更新所有实体（怪物、生物）
   - 更新子弹物理
   - 更新地图（加载/卸载网格）
   - 更新UI状态
3. **渲染阶段**：
   - 清空屏幕
   - 渲染地图
   - 渲染实体
   - 渲染子弹和特效
   - 渲染UI界面
   - 渲染HUD
   - 呈现到屏幕

### 清理阶段
释放所有资源和内存

## 技术特点

### 设计模式
- **单例模式**：Game, SoundManager, ItemLoader
- **工厂模式**：ItemLoader的物品创建
- **状态模式**：实体状态管理
- **观察者模式**：状态变化回调
- **命令模式**：Action行为系统

### 内存管理
- 智能指针（unique_ptr, shared_ptr）
- RAII原则
- 自动资源管理

### 性能优化
- 分帧异步加载
- 视距裁剪
- 对象池模式（子弹管理）
- 碰撞检测优化

### 可扩展性
- 模块化系统设计
- 配置文件驱动
- 插件式物品系统
- 网络架构预留

## 当前状态

### 重构进行中
- **Monster → Creature**：正在用新的Creature系统替换旧的Monster系统
- **状态系统升级**：从简单枚举向复杂状态效果系统过渡
- **网络功能**：基础架构已就位，待完善

### 已完成功能
- 基础游戏循环和渲染
- 玩家控制和射击
- 物品和装备系统
- 地图生成和管理
- 音效集成
- UI界面框架

### 待完善功能
- 生物AI完善
- 网络多人游戏
- 保存/加载系统
- 更多物品类型
- 任务系统

## 编译和运行

项目使用Visual Studio项目文件(.vcxproj)管理，依赖：
- SDL3
- SDL3_ttf
- nlohmann/json

注意：项目正在重构中，部分功能可能不稳定。

## 最近更新

### 物理系统重构 (2024)
对物理系统进行了重大简化，提升性能和可维护性：

#### 主要变更：
1. **移除惯性系统**: 
   - 删除friction（摩擦系数）和restitution（弹性系数）属性
   - 实体移动现在立即响应，无加速度过程

2. **简化速度控制**:
   - 直接设置velocityX/velocityY = desiredVelocityX/desiredVelocityY
   - 移除复杂的速度插值和摩擦力计算

3. **清理旧碰撞系统**:
   - 删除`checkCollisions()`方法及其实现
   - 保留但简化`resolveCollision()`方法
   - 移除弹性碰撞响应，只保留位置分离

4. **简化物理属性**:
   - 保留mass（质量）用于碰撞分离计算
   - 移除不再使用的物理参数

#### 优势：
- **性能提升**: 减少复杂的物理计算
- **响应性**: 实体移动更加直接和精确
- **维护性**: 代码更简洁，易于理解和修改
- **稳定性**: 减少物理系统相关的bug

#### 影响：
- 实体移动现在是即时的，无缓动效果
- 碰撞只进行位置分离，不影响速度
- 地形碰撞简化为纯阻挡，无反弹效果

### 智能碰撞系统 (2024)
实现了基于属性的实体碰撞机制，让碰撞更加真实和策略性：

#### 核心机制：
1. **推开能力计算**：
   - 基于力量属性：`strength`值直接影响推开他人的能力
   - 装备加成：`STRENGTH_BOOST`和`HEAVY`装备提供额外推开能力
   - 状态影响：眩晕降低能力，增益状态提升能力
   - 生命值影响：受伤会降低推开能力(50%-100%范围)

2. **抗推能力计算**：
   - 基于重量：`weight`属性决定被推开的难度
   - 装备重量：携带的装备增加抗推能力
   - 体型影响：`radius`越大越难被推动
   - 敏捷惩罚：高敏捷实体更容易被推动

3. **碰撞分离算法**：
   - 计算双方净推力：`推开能力 - 对方抗推能力`
   - 根据净推力比例分配分离距离
   - 如果双方都无法推动对方，则平均分离

#### 战术意义：
- **力量型角色**：高力量+重装备 = 难以阻挡的推进者
- **敏捷型角色**：轻装+高敏捷 = 容易被推开但移动灵活
- **坦克型角色**：重装备+高重量 = 稳如磐石的防线
- **装备选择**：重型装备提供推开能力但影响移动速度

#### 应用场景：
- 近战格斗中的位置争夺
- 门口防守时的推挤战
- 重装兵突破轻装防线
- 群体碰撞中的动态平衡

## 技术特性

### 内存管理
- 使用智能指针(unique_ptr, shared_ptr)进行自动内存管理
- RAII原则确保资源正确释放

### 性能优化
- 网格化地图系统支持无限世界
- 智能寻路系统with距离限制
- 简化物理系统减少计算开销

### 网络架构
- PlayerController抽象层支持本地/远程玩家
- 为多人游戏预留扩展接口

## 构建要求
- SDL3开发库
- C++17或更高版本
- Visual Studio 2019/2022 (Windows)

## 文件结构
```
MyGame/
├── 核心系统/
│   ├── Game.cpp/h          # 游戏主循环
│   ├── Entity.cpp/h        # 基础实体类
│   ├── Player.cpp/h        # 玩家系统
│   └── Creature.cpp/h      # AI生物系统
├── 物品系统/
│   ├── Item.cpp/h          # 物品基类
│   ├── Gun.cpp/h           # 武器系统
│   └── Storage.cpp/h       # 存储系统
├── 地图系统/
│   ├── Map.cpp/h           # 地图管理
│   ├── Grid.cpp/h          # 网格系统
│   └── Tile.cpp/h          # 地形块
└── 资源文件/
    ├── assets/             # 游戏资源
    └── jsons/              # 配置文件
```

## 开发状态
- ✅ 基础框架完成
- ✅ 物品系统重构完成
- ✅ Creature系统替换Monster
- ✅ 物理系统简化完成
- 🔄 网络系统开发中
- 📋 UI系统待优化